# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supabase Storage –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

## ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–´–ü–û–õ–ù–ò–¢–¨ –ü–ï–†–ï–î –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï–ú

–î–ª—è —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Storage Bucket –≤ Supabase.

## üîß –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å Bucket

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://app.supabase.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –í –ª–µ–≤–æ–º –º–µ–Ω—é: **Storage**
4. –ù–∞–∂–º–∏—Ç–µ **"New bucket"**
5. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **Name:** `unit-photos`
   - **Public bucket:** ‚úÖ Yes (–≤–∫–ª—é—á–∏—Ç—å)
   - **File size limit:** `5242880` (5MB –≤ –±–∞–π—Ç–∞—Ö)
   - **Allowed MIME types:** `image/jpeg,image/png,image/webp`
6. –ù–∞–∂–º–∏—Ç–µ **"Create bucket"**

## üîí –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ü–æ–ª–∏—Ç–∏–∫–∏

–í Supabase Dashboard:

1. **Storage** ‚Üí **Policies** ‚Üí **New policy** (–¥–ª—è bucket `unit-photos`)

### –ü–æ–ª–∏—Ç–∏–∫–∞ 1: –ó–∞–≥—Ä—É–∑–∫–∞ (INSERT)

**Name:** `Users can upload to their warehouse`

**Target roles:** `authenticated`

**Policy definition (WITH CHECK):**
```sql
bucket_id = 'unit-photos' 
AND (storage.foldername(name))[1] IN (
  SELECT warehouse_id::text 
  FROM profiles 
  WHERE id = auth.uid()
)
```

### –ü–æ–ª–∏—Ç–∏–∫–∞ 2: –ß—Ç–µ–Ω–∏–µ (SELECT)

**Name:** `Authenticated users can read photos`

**Target roles:** `authenticated`

**Policy definition (USING):**
```sql
bucket_id = 'unit-photos'
```

### –ü–æ–ª–∏—Ç–∏–∫–∞ 3: –£–¥–∞–ª–µ–Ω–∏–µ (DELETE)

**Name:** `Users can delete from their warehouse`

**Target roles:** `authenticated`

**Policy definition (USING):**
```sql
bucket_id = 'unit-photos' 
AND (storage.foldername(name))[1] IN (
  SELECT warehouse_id::text 
  FROM profiles 
  WHERE id = auth.uid()
)
```

## üß™ –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### SQL Query –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ bucket

```sql
SELECT * FROM storage.buckets WHERE name = 'unit-photos';
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
id        | name        | public
----------|-------------|--------
...       | unit-photos | true
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π –∑–∞–∫–∞–∑: `/app/units/[unitId]`
2. –ù–∞–∂–º–∏—Ç–µ "+ –î–æ–±–∞–≤–∏—Ç—å" –≤ —Å–µ–∫—Ü–∏–∏ "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ
4. –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ - –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "Failed to upload photo"

**–ü—Ä–∏—á–∏–Ω–∞:** Bucket –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ bucket –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ `unit-photos` (–Ω–µ `unit_photos` –∏–ª–∏ –¥—Ä—É–≥–æ–µ)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ bucket public
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

### –û—à–∏–±–∫–∞: "Forbidden"

**–ü—Ä–∏—á–∏–Ω–∞:** RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ 3 –ø–æ–ª–∏—Ç–∏–∫–∏ (INSERT, SELECT, DELETE)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles` —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω `warehouse_id`

### –û—à–∏–±–∫–∞: "File too large"

**–ü—Ä–∏—á–∏–Ω–∞:** –§–∞–π–ª –±–æ–ª—å—à–µ 5MB

**–†–µ—à–µ–Ω–∏–µ:**
- –°–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö bucket

### –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** Bucket –Ω–µ public

**–†–µ—à–µ–Ω–∏–µ:**
1. Storage ‚Üí `unit-photos` ‚Üí Settings
2. –í–∫–ª—é—á–∏—Ç—å **"Public bucket"**
3. Save

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: SQL

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å bucket —á–µ—Ä–µ–∑ SQL:

```sql
-- –°–æ–∑–¥–∞—Ç—å bucket
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'unit-photos',
  'unit-photos',
  true,
  5242880,
  ARRAY['image/jpeg', 'image/png', 'image/webp']
);

-- RLS –ø–æ–ª–∏—Ç–∏–∫–∏
-- (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Å–µ–∫—Ü–∏–∏ "–®–∞–≥ 2" –≤—ã—à–µ)
```

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö —à–∞–≥–æ–≤:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ –∫ –∑–∞–∫–∞–∑–∞–º
- ‚úÖ –§–æ—Ç–æ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- ‚úÖ –î–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ RLS
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è

---

**–í–∞–∂–Ω–æ:** –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å **–û–î–ò–ù –†–ê–ó** –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
