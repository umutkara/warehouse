# FIX REPORT: Печать этикеток для warehouse_cells

## Дата: 2024
## Задача: Создать страницу для печати этикеток ячеек с штрихкодами и цветными квадратами

---

## ОБЗОР ИЗМЕНЕНИЙ

Создана страница для печати этикеток ячеек склада:
- Штрихкоды в формате CODE128 с кодированием "CELL:<CODE>"
- Цветные квадраты по типу ячейки (совпадают с картой)
- Размер этикетки: 58mm x 30mm (для маленьких принтеров)
- Поддержка печати одной этикетки или всех сразу
- Print CSS для правильной печати

---

## СОЗДАННЫЕ ФАЙЛЫ

### 1. `lib/ui/cellColors.ts` (НОВЫЙ)

**Назначение:** Общий helper для получения цветов ячеек по типу

**Содержимое:**
- Функция `getCellColor(cell_type: string, meta?: any): string`
- Возвращает цвет в формате hex (#rrggbb)
- Учитывает блокировку ячейки (meta?.blocked)
- Цвета совпадают с картой склада

**Цвета по типам:**
- `receiving`: #e3f2fd (голубой)
- `bin`: #fff8e1 (жёлтый)
- `storage`: #e8f5e9 (зелёный)
- `shipping`: #f3e5f5 (фиолетовый)
- `transfer`: #eceff1 (серый)
- `blocked`: #ffebee (красный, если meta.blocked = true)
- `default`: #ffffff (белый)

**Блок кода:**
```typescript
export function getCellColor(cell_type: string, meta?: any): string {
  // Если ячейка заблокирована, возвращаем цвет блока
  if (meta?.blocked) return "#ffebee";
  
  // Цвета по типу ячейки (совпадают с картой)
  switch (cell_type) {
    case "receiving": return "#e3f2fd"; // голубой
    case "bin": return "#fff8e1"; // жёлтый
    case "storage": return "#e8f5e9"; // зелёный
    case "shipping": return "#f3e5f5"; // фиолетовый
    case "transfer": return "#eceff1"; // серый
    default: return "#ffffff"; // белый
  }
}
```

---

### 2. `app/app/cells/labels/page.tsx` (НОВЫЙ)

**Назначение:** Страница для просмотра и печати этикеток ячеек

**Функциональность:**
- Загружает ячейки через GET /api/cells/list
- Отображает preview всех этикеток
- Кнопка "Печать" для каждой этикетки
- Кнопка "Печать всех" для массовой печати
- Кнопка "Обновить" для перезагрузки списка

**Компонент CellLabel:**
- Генерирует штрихкод через jsbarcode
- Формат штрихкода: CODE128
- Кодируемая строка: "CELL:<CODE>" (например, "CELL:A1")
- Под штрихкодом: человекочитаемый код (без "CELL:")
- Цветной квадрат 18x18px с цветом зоны
- Текст: CODE (14px, bold) и cell_type (10px, lowercase)

**Layout этикетки:**
- Размер: 58mm x 30mm
- Левая часть: штрихкод (flex: 1)
- Правая часть: цветной квадрат + текст (flex: 1)
- Padding: 4mm
- Gap между частями: 3mm

**Print CSS:**
- @media print скрывает все кнопки и заголовки
- Показывает только этикетки
- @page size: 58mm 30mm
- page-break-after: always для каждой этикетки
- Правильное позиционирование при печати

**Блок кода (штрихкод):**
```typescript
// Кодируем строку вида "CELL:<CODE>"
const barcodeValue = `CELL:${cell.code}`;

JsBarcode(barcodeRef.current, barcodeValue, {
  format: "CODE128",
  displayValue: false, // Не показываем текст под штрихкодом (будем свой)
  margin: 2,
  height: 40,
  width: 1.5,
});
```

**Блок кода (печать одной этикетки):**
```typescript
function printLabel(cellId: string) {
  // Скрываем все этикетки кроме выбранной
  const allLabels = document.querySelectorAll("[data-cell-id]");
  allLabels.forEach((label) => {
    if (label.getAttribute("data-cell-id") !== cellId) {
      (label as HTMLElement).style.display = "none";
    }
  });

  window.print();

  // После печати показываем все обратно
  setTimeout(() => {
    allLabels.forEach((label) => {
      (label as HTMLElement).style.display = "inline-block";
    });
  }, 1000);
}
```

---

## ИЗМЕНЁННЫЕ ФАЙЛЫ

### 3. `app/app/warehouse-map/page.tsx`

**Изменения:**
- **Строка 5**: Добавлен импорт `getCellColor` из `@/lib/ui/cellColors`
- **Строки 22-32**: Функция `cellBg()` переписана для использования общего helper

**Детали:**
- Теперь карта использует общий helper для цветов
- Цвета остались теми же, но логика централизована
- Упрощена поддержка кода

**Блок кода:**
```typescript
function cellBg(cell: any) {
  // Используем общий helper для цветов
  return getCellColor(cell.cell_type, cell.meta);
}
```

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ

### Штрихкод
- **Библиотека:** jsbarcode (уже в проекте)
- **Формат:** CODE128
- **Кодируемая строка:** "CELL:<CODE>" (например, "CELL:A1", "CELL:B2-3")
- **Отображение:** Только штрихкод, текст кода под ним отдельно
- **Размер:** height: 40px, width: 1.5

### Цвета
- **Источник:** lib/ui/cellColors.ts
- **Использование:** Карта склада и этикетки
- **Формат:** Hex цвета (#rrggbb)
- **Учёт блокировки:** Если meta.blocked = true, возвращается красный цвет

### Размеры этикетки
- **Ширина:** 58mm
- **Высота:** 30mm
- **Padding:** 4mm
- **Gap между частями:** 3mm
- **Квадрат:** 18x18px

### Печать
- **Размер страницы:** @page size: 58mm 30mm
- **Разрывы:** page-break-after: always для каждой этикетки
- **Скрытие UI:** Все кнопки и заголовки скрываются при печати
- **Позиционирование:** Абсолютное позиционирование для правильной печати

---

## ПРОВЕРКА КАЧЕСТВА КОДА

### Линтер
✅ **Результат**: Ошибок не найдено
```bash
read_lints для всех изменённых файлов
```

### Сборка
✅ **Результат**: Успешно скомпилировано
```bash
npm run build
✓ Compiled successfully in 991.5ms
✓ Generating static pages using 9 workers (30/30) in 61.6ms
```

### TypeScript
✅ **Результат**: Все типы корректны
- Использованы правильные типы для Cell
- useRef правильно типизирован для SVG

---

## ТЕСТИРОВАНИЕ

### URL страницы
```
/app/cells/labels
```

### Как тестировать

1. **Открыть страницу:**
   - Перейти на `/app/cells/labels`
   - Должны загрузиться все ячейки из склада

2. **Печать одной этикетки:**
   - Нажать кнопку "Печать" под нужной этикеткой
   - Откроется диалог печати
   - В предпросмотре должна быть видна только одна этикетка
   - После печати все этикетки снова видны

3. **Печать всех этикеток:**
   - Нажать кнопку "Печать всех" вверху страницы
   - Откроется диалог печати
   - В предпросмотре должны быть видны все этикетки
   - Каждая этикетка на отдельной странице

4. **Проверка штрихкода:**
   - Отсканировать штрихкод сканером
   - Должна декодироваться строка вида "CELL:A1"
   - Под штрихкодом должен быть виден код ячейки (A1)

5. **Проверка цветов:**
   - Цветной квадрат должен соответствовать типу ячейки
   - Цвета должны совпадать с картой склада

6. **Проверка размеров:**
   - Этикетка должна быть 58mm x 30mm
   - Подходит для маленьких принтеров (58mm лента)

---

## ВАЖНЫЕ ЗАМЕЧАНИЯ

1. **БД не изменялась**: Все изменения только во фронтенде
2. **TopBarExcel не затронут**: Используется та же библиотека jsbarcode, но для других целей
3. **Цвета централизованы**: Теперь карта и этикетки используют один helper
4. **Формат штрихкода**: Строго "CELL:<CODE>" для единообразия
5. **Размер этикетки**: 58mm x 30mm оптимизирован для маленьких принтеров

---

## ЗАКЛЮЧЕНИЕ

Страница печати этикеток успешно создана:
- ✅ Штрихкоды в формате CODE128 с кодированием "CELL:<CODE>"
- ✅ Цветные квадраты по типу ячейки
- ✅ Размер 58mm x 30mm для маленьких принтеров
- ✅ Печать одной или всех этикеток
- ✅ Print CSS для правильной печати
- ✅ Общий helper для цветов (используется в карте и этикетках)
- ✅ Код скомпилирован без ошибок

Код готов к использованию.
