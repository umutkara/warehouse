# Fix Report: Ops -> Shipping Tasks (Picking Tasks)

## Дата: 2025-01-XX

## Обзор
Реализован новый функционал "Ops -> Shipping tasks (пикинг в picking-ячейку)" для создания заданий складчикам на перемещение units из storage/shipping в picking ячейки.

## Измененные файлы

### SQL Миграции
1. **`supabase_migration_picking_tasks.sql`** (НОВЫЙ)
   - Создание таблицы `picking_tasks`
   - RLS политики для доступа по ролям
   - Индексы для производительности
   - Комментарии для документации

### API Routes
2. **`app/api/ops/picking-tasks/create/route.ts`** (НОВЫЙ)
   - POST `/api/ops/picking-tasks/create`
   - Создание задач на перемещение units в picking ячейки
   - Доступ: admin/head/manager/ops

3. **`app/api/tsd/shipping-tasks/list/route.ts`** (НОВЫЙ)
   - GET `/api/tsd/shipping-tasks/list`
   - Получение списка открытых и в работе задач
   - Доступ: worker/ops/admin/head/manager

4. **`app/api/tsd/shipping-tasks/complete/route.ts`** (НОВЫЙ)
   - POST `/api/tsd/shipping-tasks/complete`
   - Выполнение задачи через сканирование FROM/UNIT/TO
   - Обработка inventory_active (423 статус)
   - Доступ: worker/ops/admin/head/manager

### UI Страницы
5. **`app/app/ops-shipping/page.tsx`** (НОВЫЙ)
   - Страница для создания заданий на отгрузку
   - Поиск units по штрихкоду
   - Выбор целевой picking ячейки
   - Поле сценария (опционально)
   - Создание задач

6. **`app/app/tsd/page.tsx`** (ИЗМЕНЕН)
   - Добавлен режим `"shipping"` в тип `Mode`
   - Добавлено состояние для shipping tasks:
     - `shippingTasks`, `currentTask`, `loadingTasks`
     - `shippingFromCell`, `shippingUnit`, `shippingToCell`
   - Добавлена функция `loadShippingTasks()` для загрузки задач
   - Добавлена функция `handleShippingScan()` для обработки сканирования
   - Добавлена функция `handleCompleteShippingTask()` для выполнения задачи
   - Обновлена функция `handleReset()` для режима shipping
   - Добавлен UI для режима "Отгрузка" в переключателе режимов
   - Добавлен UI блок для отображения текущей задачи и последовательности сканирования

7. **`app/app/ui/LeftNav.tsx`** (ИЗМЕНЕН)
   - Добавлена переменная `canOps` для роли ops
   - Добавлена переменная `canViewTasks` для ролей, которые могут видеть задачи
   - Добавлен раздел "OPS" с ссылкой "Создать задания" (`/app/ops-shipping`)
   - Обновлена логика отображения ТСД для роли ops
   - Добавлены заголовки разделов для лучшей навигации

## Функциональность

### Создание задач (Ops)
1. **Доступ:** роли admin/head/manager/ops
2. **Процесс:**
   - Поиск units по штрихкоду через `/api/units/by-barcode`
   - Добавление units в список выбранных
   - Выбор целевой picking ячейки (обязательно)
   - Ввод сценария (опционально)
   - Создание задач (одна задача на unit)

### Выполнение задач (Worker/Ops)
1. **Доступ:** роли worker/ops/admin/head/manager
2. **Процесс:**
   - Режим "Отгрузка" в ТСД показывает список задач (open/in_progress)
   - Последовательность сканирования:
     1. FROM ячейка (storage/shipping)
     2. UNIT штрихкод
     3. TO ячейка (picking)
   - После 3-го скана автоматически выполняется задача:
     - Проверка, что unit находится в FROM ячейке
     - Проверка разрешений перемещения (storage/shipping -> picking разрешено)
     - Перемещение через `move_unit_to_cell` с статусом 'picking'
     - Закрытие задачи (status -> 'done')
   - Автоматический переход к следующей задаче

### Обработка ошибок
1. **Инвентаризация активна:**
   - Статус 423 при попытке перемещения
   - Понятное уведомление: "Инвентаризация активна. Перемещения заблокированы."
   - Задача НЕ закрывается

2. **Ошибки валидации:**
   - Unit не в FROM ячейке → ошибка, задача не закрывается
   - TO ячейка не совпадает с задачей → ошибка
   - Штрихкод не совпадает с задачей → ошибка
   - Недопустимое перемещение (bin -> picking) → ошибка

## Безопасность

### RLS Политики
1. **SELECT:** все роли warehouse могут читать задачи
2. **INSERT:** только admin/head/manager/ops могут создавать задачи
3. **UPDATE:** admin/head/manager/ops/worker могут обновлять, но worker НЕ может менять `target_picking_cell_id`

### API Проверки
- Все endpoints проверяют роль пользователя
- Проверка принадлежности к warehouse
- Проверка прав на создание/выполнение задач
- Валидация данных перед выполнением

## Тестирование

### Шаг 1: Применить SQL миграцию
```sql
-- Выполнить в Supabase SQL Editor
-- Файл: supabase_migration_picking_tasks.sql
```

### Шаг 2: Тестирование создания задач (Ops)
1. Войти как пользователь с ролью `ops` (или admin/head/manager)
2. Перейти в раздел "OPS" → "Создать задания"
3. Отсканировать или ввести штрихкод unit
4. Выбрать целевую picking ячейку
5. Опционально: ввести сценарий
6. Нажать "Создать задания"
7. **Ожидаемый результат:** задачи созданы, отображается количество созданных задач

### Шаг 3: Тестирование выполнения задач (Worker/Ops)
1. Войти как пользователь с ролью `worker` (или ops/admin/head/manager)
2. Перейти в ТСД (`/app/tsd`)
3. Выбрать режим "Отгрузка"
4. **Ожидаемый результат:** отображается текущая задача с информацией о unit и целевой ячейке
5. Отсканировать FROM ячейку (storage/shipping)
   - **Ожидаемый результат:** FROM ячейка отображается
6. Отсканировать штрихкод unit
   - **Ожидаемый результат:** UNIT отображается
   - Если штрихкод не совпадает с задачей → ошибка
7. Отсканировать TO ячейку (picking)
   - **Ожидаемый результат:** автоматически выполняется перемещение, задача закрывается, успешное уведомление
   - Автоматически берется следующая задача (если есть)

### Шаг 4: Тестирование ошибок
1. **Unit не в FROM ячейке:**
   - Создать задачу для unit в ячейке A1
   - Попытаться выполнить задачу, отсканировав FROM ячейку B1
   - **Ожидаемый результат:** ошибка "Unit находится не в ячейке..."

2. **Инвентаризация активна:**
   - Включить инвентаризацию в разделе "Инвентаризация"
   - Попытаться выполнить задачу
   - **Ожидаемый результат:** статус 423, уведомление "Инвентаризация активна...", задача НЕ закрывается

3. **Недопустимое перемещение:**
   - Попытаться создать задачу с FROM ячейкой типа `bin`
   - **Ожидаемый результат:** задача не должна создаваться (проверка в коде)

### Шаг 5: Тестирование прав доступа
1. **Worker не может менять target picking cell:**
   - Войти как worker
   - Попытаться выполнить задачу, отсканировав другую TO ячейку
   - **Ожидаемый результат:** ошибка "Ячейка не совпадает с задачей"

2. **Guest не может видеть задачи:**
   - Войти как guest
   - Попытаться открыть `/app/ops-shipping` или ТСД в режиме "Отгрузка"
   - **Ожидаемый результат:** 403 Forbidden или отсутствие доступа

## Примечания

### Важные моменты
1. **Никаких изменений в `/login`** - как требовалось
2. **Минимальные риски для продакшена:**
   - Новые таблицы и endpoints не влияют на существующий функционал
   - Существующие режимы ТСД не изменены
   - Добавлены только новые функции

3. **Обратная совместимость:**
   - Все существующие endpoints работают как раньше
   - Существующие режимы ТСД не изменены
   - Навигация расширена, но не изменена для существующих ролей

### Известные ограничения
1. Worker не может изменить целевую picking ячейку после создания задачи (по дизайну)
2. Задачи автоматически закрываются после успешного выполнения (отмены нет)
3. При ошибке выполнения задачи она остается открытой (можно повторить)

## Следующие шаги (опционально)
1. Добавить возможность отмены задач (ops/admin)
2. Добавить историю выполненных задач
3. Добавить статистику по задачам
4. Добавить фильтры и поиск в списке задач

## Заключение
Функционал полностью реализован и готов к тестированию. Все требования выполнены:
- ✅ Создание задач ops
- ✅ Выполнение задач worker через ТСД
- ✅ Валидация и обработка ошибок
- ✅ Обработка inventory_active
- ✅ Ограничения по ролям
- ✅ Безопасность через RLS
- ✅ Мобильная адаптация ТСД
- ✅ Никаких изменений в /login
