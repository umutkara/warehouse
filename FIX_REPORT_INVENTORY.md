# FIX REPORT: Режим инвентаризации (Inventory Mode)

## Обзор
Добавлен режим инвентаризации, который блокирует все перемещения unit на время инвентаризации. Блокировка реализована на уровне БД (RPC функции), а также на фронте с понятными сообщениями об ошибках на русском языке.

## Созданные/Изменённые файлы

### SQL Миграция
- **`supabase_migration_inventory.sql`** (новый)
  - Добавляет поля `inventory_active` и `inventory_session_id` в таблицу `warehouses`
  - Создаёт таблицу `inventory_sessions` для отслеживания сессий инвентаризации
  - Создаёт RPC функции: `inventory_start()`, `inventory_stop()`, `inventory_status()`
  - Обновляет RPC функции `move_unit()` и `move_unit_to_cell()` с проверкой инвентаризации

### Backend API Routes (новые)
- **`app/api/inventory/start/route.ts`** — POST эндпоинт для запуска инвентаризации
- **`app/api/inventory/stop/route.ts`** — POST эндпоинт для завершения инвентаризации
- **`app/api/inventory/status/route.ts`** — GET эндпоинт для получения статуса инвентаризации

### Backend API Routes (изменённые)
- **`app/api/units/assign/route.ts`** — добавлена обработка ошибки `INVENTORY_ACTIVE` (возвращает 423)
- **`app/api/units/move/route.ts`** — добавлена обработка ошибки `INVENTORY_ACTIVE` (возвращает 423)
- **`app/api/units/move-by-scan/route.ts`** — добавлена обработка ошибки `INVENTORY_ACTIVE` в двух местах (новый и legacy формат)

### Frontend (новые)
- **`app/app/inventory/page.tsx`** — страница управления инвентаризацией

### Frontend (изменённые)
- **`app/app/ui/LeftNav.tsx`** — добавлен пункт меню "Инвентаризация"
- **`app/app/tsd/page.tsx`** — добавлена обработка ошибки 423 и крупное красное уведомление

## SQL для выполнения

Выполните миграцию в Supabase SQL Editor:

```sql
-- Скопируйте и выполните весь файл:
-- supabase_migration_inventory.sql
```

Миграция включает:
1. Добавление полей `inventory_active` и `inventory_session_id` в `warehouses`
2. Создание таблицы `inventory_sessions` с RLS политиками
3. Создание RPC функций `inventory_start()`, `inventory_stop()`, `inventory_status()`
4. Обновление `move_unit()` и `move_unit_to_cell()` с проверкой инвентаризации

## Как тестировать (минимум 5 шагов)

### Шаг 1: Подготовка
1. Убедитесь, что миграция выполнена в Supabase
2. Убедитесь, что у вас есть пользователь с ролью `admin`, `head` или `manager`
3. Запустите приложение: `npm run dev`

### Шаг 2: Проверка страницы инвентаризации
1. Войдите в систему под пользователем с ролью `admin`/`head`/`manager`
2. В левом меню найдите пункт "Инвентаризация" и перейдите на `/app/inventory`
3. Убедитесь, что статус показывает "Не активна"
4. Убедитесь, что видна кнопка "Начать инвентаризацию"

### Шаг 3: Запуск инвентаризации
1. На странице `/app/inventory` нажмите кнопку "Начать инвентаризацию"
2. Убедитесь, что статус изменился на "Активна" (красным цветом)
3. Убедитесь, что отображается дата и время начала
4. Убедитесь, что кнопка изменилась на "Завершить инвентаризацию"

### Шаг 4: Проверка блокировки перемещений
1. Попробуйте переместить unit через любой из API эндпоинтов:
   - POST `/api/units/assign` (с `unitId`, `cellId`, `toStatus`)
   - POST `/api/units/move` (с `unitId`, `toCellId`)
   - POST `/api/units/move-by-scan` (с `fromCellCode`, `toCellCode`, `unitBarcode`)
2. Убедитесь, что все возвращают статус **423 (Locked)**
3. Убедитесь, что JSON содержит: `{ error: "Инвентаризация активна. Перемещения заблокированы." }`

### Шаг 5: Проверка UI блокировки (ТСД страница)
1. Откройте страницу `/app/tsd`
2. Выберите режим "Перемещение"
3. Попробуйте выполнить перемещение (отсканируйте FROM ячейку, unit, TO ячейку)
4. Убедитесь, что вверху страницы появляется **крупное красное уведомление** с текстом "Инвентаризация активна. Перемещения заблокированы."
5. Уведомление должно исчезнуть через 5 секунд (или при следующей попытке)

### Шаг 6: Завершение инвентаризации
1. Вернитесь на страницу `/app/inventory`
2. Нажмите кнопку "Завершить инвентаризацию"
3. Убедитесь, что статус изменился на "Не активна" (зелёным цветом)
4. Убедитесь, что кнопка изменилась на "Начать инвентаризацию"

### Шаг 7: Проверка разблокировки
1. После завершения инвентаризации попробуйте снова переместить unit через API
2. Убедитесь, что перемещения снова работают (возвращают успешный ответ)

### Шаг 8: Проверка доступа
1. Войдите под пользователем с ролью `worker`
2. Перейдите на `/app/inventory`
3. Убедитесь, что статус отображается (можно видеть)
4. Убедитесь, что кнопки "Начать"/"Завершить" **НЕ видны** (только для admin/head/manager)

## Важные детали

1. **Блокировка на уровне БД**: RPC функции `move_unit()` и `move_unit_to_cell()` выбрасывают исключение `INVENTORY_ACTIVE`, если `warehouses.inventory_active = true`

2. **Единая ошибка**: Все API routes возвращают одинаковое сообщение на русском: `"Инвентаризация активна. Перемещения заблокированы."` со статусом 423

3. **Доступы**:
   - Старт/стоп: только `admin`, `head`, `manager`
   - Просмотр статуса: все авторизованные роли (включая `worker`)

4. **UI уведомления**: 
   - На странице ТСД показывается крупное красное уведомление сверху при ошибке 423
   - Автоматически исчезает через 5 секунд

5. **Build проверен**: `npm run build` выполняется успешно, все маршруты доступны

## Проверка маршрутов

После build должны быть доступны:
- ✅ `/api/inventory/start` (POST)
- ✅ `/api/inventory/stop` (POST)
- ✅ `/api/inventory/status` (GET)
- ✅ `/app/inventory` (страница)

## Возможные проблемы

1. Если миграция не выполнена — RPC функции не будут работать
2. Если роль пользователя не `admin`/`head`/`manager` — кнопки старт/стоп не появятся
3. Если инвентаризация активна, но перемещения всё равно проходят — проверьте, что миграция применилась к обеим RPC функциям
